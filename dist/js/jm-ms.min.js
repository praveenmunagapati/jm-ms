var jm=jm||{};"undefined"!=typeof module&&module.exports&&(jm=require("jm-core")),function(){if(!jm.ms){var e=jm.ERR;jm.ms=function(e){var r=jm.ms.router(e);return r},jm.ms.proxy=function(r,t){r||(r={});var n=null,i=null;if("string"==typeof r&&(r={uri:r}),!r.uri&&(i=e.FA_PARAMS,n=new Error(i.msg,i.err),!t))throw n;var o=jm.ms();return jm.ms.client(r,function(e,r){return e?t(e,r):(o.use(function(e,t){r.request(e,t)}),o.client=r,void(t&&t(null,o)))}),o}}}();var jm=jm||{};"undefined"!=typeof module&&module.exports&&(jm=require("jm-core")),function(){if(!jm.ms.consts){var e=jm.ms,r=900;jm.ERR.ms={FA_INVALIDTYPE:{err:r++,msg:"无效的类型"}},e.consts={}}}();var jm=jm||{};"undefined"!=typeof exports&&"undefined"!=typeof module&&(jm=require("jm-core")),function(){function e(e){for(var r,t=[],n=0,o=0,u="";null!=(r=m.exec(e));){var s=r[0],a=r[1],f=r.index;if(u+=e.slice(o,f),o=f+s.length,a)u+=a[1];else{u&&(t.push(u),u="");var l=r[2],c=r[3],p=r[4],h=r[5],d=r[6],v=r[7],y="+"===d||"*"===d,g="?"===d||"*"===d,j=l||"/",x=p||h||(v?".*":"[^"+j+"]+?");t.push({name:c||n++,prefix:l||"",delimiter:j,optional:g,repeat:y,pattern:i(x)})}}return o<e.length&&(u+=e.substr(o)),u&&t.push(u),t}function r(r){return t(e(r))}function t(e){for(var r=new Array(e.length),t=0;t<e.length;t++)"object"==typeof e[t]&&(r[t]=new RegExp("^"+e[t].pattern+"$"));return function(t){for(var n="",i=t||{},o=0;o<e.length;o++){var u=e[o];if("string"!=typeof u){var s,a=i[u.name];if(null==a){if(u.optional)continue;throw new TypeError('Expected "'+u.name+'" to be defined')}if(p(a)){if(!u.repeat)throw new TypeError('Expected "'+u.name+'" to not repeat, but received "'+a+'"');if(0===a.length){if(u.optional)continue;throw new TypeError('Expected "'+u.name+'" to not be empty')}for(var f=0;f<a.length;f++){if(s=encodeURIComponent(a[f]),!r[o].test(s))throw new TypeError('Expected all "'+u.name+'" to match "'+u.pattern+'", but received "'+s+'"');n+=(0===f?u.prefix:u.delimiter)+s}}else{if(s=encodeURIComponent(a),!r[o].test(s))throw new TypeError('Expected "'+u.name+'" to match "'+u.pattern+'", but received "'+s+'"');n+=u.prefix+s}}else n+=u}return n}}function n(e){return e.replace(/([.+*?=^!:${}()[\]|\/])/g,"\\$1")}function i(e){return e.replace(/([=!:$\/()])/g,"\\$1")}function o(e,r){return e.keys=r,e}function u(e){return e.sensitive?"":"i"}function s(e,r){var t=e.source.match(/\((?!\?)/g);if(t)for(var n=0;n<t.length;n++)r.push({name:n,prefix:null,delimiter:null,optional:!1,repeat:!1,pattern:null});return o(e,r)}function a(e,r,t){for(var n=[],i=0;i<e.length;i++)n.push(c(e[i],r,t).source);var s=new RegExp("(?:"+n.join("|")+")",u(t));return o(s,r)}function f(r,t,n){for(var i=e(r),u=l(i,n),s=0;s<i.length;s++)"string"!=typeof i[s]&&t.push(i[s]);return o(u,t)}function l(e,r){r=r||{};for(var t=r.strict,i=r.end!==!1,o="",s=e[e.length-1],a="string"==typeof s&&/\/$/.test(s),f=0;f<e.length;f++){var l=e[f];if("string"==typeof l)o+=n(l);else{var c=n(l.prefix),p=l.pattern;l.repeat&&(p+="(?:"+c+p+")*"),p=l.optional?c?"(?:"+c+"("+p+"))?":"("+p+")?":c+"("+p+")",o+=p}}return t||(o=(a?o.slice(0,-2):o)+"(?:\\/(?=$))?"),o+=i?"$":t&&a?"":"(?=\\/|$)",new RegExp("^"+o,u(r))}function c(e,r,t){return r=r||[],p(r)?t||(t={}):(t=r,r=[]),e instanceof RegExp?s(e,r,t):p(e)?a(e,r,t):f(e,r,t)}if(!jm.ms.pathToRegexp){jm.ms.pathToRegexp=c,c.parse=e,c.compile=r,c.tokensToFunction=t,c.tokensToRegExp=l;var p=Array.isArray||function(e){return"[object Array]"==Object.prototype.toString.call(e)},m=new RegExp(["(\\\\.)","([\\/.])?(?:(?:\\:(\\w+)(?:\\(((?:\\\\.|[^()])+)\\))?|\\(((?:\\\\.|[^()])+)\\))([+*?])?|(\\*))"].join("|"),"g")}}();var jm=jm||{};"undefined"!=typeof module&&module.exports&&(jm=require("jm-core")),function(){if(!jm.ms.Route){var e=jm.ms,r=(jm.ERR,e.pathToRegexp),t=jm.TagObject.extend({_className:"route",ctor:function(e){this._super(),e&&this.attr(e),this._fns=[],Object.defineProperty(this,"fns",{value:this._fns,writable:!1}),this.uri=this.uri||"/",this.keys=[],this.regexp=r(this.uri,this.keys,e),"/"===this.uri&&e.end===!1&&(this.regexp.fast_slash=!0),void 0==this.type&&(this.allType=!0);var t=e.fn;Array.isArray(t)||(t=[t]);for(var n=0;n<t.length;n++){var i=t[n];if("function"!=typeof i){var o=toString.call(i),u="requires callback functions but got a "+o;throw new TypeError(u)}this._fns.push(i)}},handle:function(e,r,t){function n(u,s){if(u)return"route"===u?t():r(u,s);var a=o[i++];if(!a)return t(u);try{a(e,r,n)}catch(e){n(e)}}var i=0,o=this.fns;return 0===o.length?t():void n()},match:function(e,r){if(r&&(r=r.toLowerCase()),r!=this.type&&!this.allType)return!1;if(null==e)return this.params=void 0,this.uri=void 0,!1;if(this.regexp.fast_slash)return this.params={},this.uri="",!0;var t=this.regexp.exec(e);if(!t)return this.params=void 0,this.uri=void 0,!1;this.params={},this.uri=t[0];for(var n=this.keys,i=this.params,o=1;o<t.length;o++){var u=n[o-1],s=u.name;i[s]=t[o]}return!0}});e.Route=t,e.route=function(e){return new t(e)}}}();var jm=jm||{};"undefined"!=typeof module&&module.exports&&(jm=require("jm-core")),function(){if(!jm.ms.Router){var e=jm.ms,r=jm.ERR,t=function(e,r){},n=Array.prototype.slice,i=jm.TagObject.extend({_className:"router",ctor:function(r){var t=this;this._super(),r&&this.attr(r),this._routes=[],Object.defineProperty(this,"routes",{value:this._routes,writable:!1}),e.utils.enableType(t,["get","post","put","delete"])},clear:function(e,r){return this._routes.splice(0),r&&r(null,!0),this},_add:function(t,n){t=t||{};var i=null,o=null;if(t.uri&&t.fn){this.emit("add",t);var u={};for(var s in t)u[s]=t[s];void 0===u.mergeParams&&(u.mergeParams=this.mergeParams),void 0===u.sensitive&&(u.sensitive=this.sensitive),void 0===u.strict&&(u.strict=this.strict);var a=e.route(u);this._routes.push(a)}else if(o=r.FA_PARAMS,i=new Error(o.msg),!n)throw i;return n&&n(i,o),this},add:function(e,r){return"string"==typeof e&&(e={uri:e},"string"==typeof r?(e.type=r,Array.isArray(arguments[2])?e.fn=arguments[2]:e.fn=n.call(arguments,2)):Array.isArray(r)?e.fn=r:e.fn=n.call(arguments,1),r=null),this._add(e,r)},_use:function(e,t){e=e||{};var n=null,o=null;if(e&&e instanceof i&&(e={fn:e}),e.fn){if(this.emit("use",e),e.strict=!1,e.end=!1,e.uri=e.uri||"/",e.fn instanceof i){var u=e.fn;e.router=u,e.fn=function(e,r,t){u.handle(e,r,t)}}else if("object"==typeof e.fn){var u=e.fn;u.request?(e.router=u,e.fn=function(e,r,t){u.request(e,function(e,n){r(e,n),t()})}):u.handle&&(e.router=u,e.fn=function(e,r,t){u.handle(e,r,t)})}return this._add(e,t)}if(o=r.FA_PARAMS,n=new Error(o.msg,o.err),!t)throw n;return t&&t(n,o),this},use:function(e,r){return"string"==typeof e?(e={uri:e},"object"==typeof r?e.fn=r:e.fn=n.call(arguments,1),r=null):"function"==typeof e?(e={fn:n.call(arguments,0)},r=null):Array.isArray(e)&&(e={fn:e},r=null),this._use(e,r)},_proxy:function(t,n){var i=this;if(t||(t={}),n||(n=function(e,r){if(e)throw e}),!t.target){var o=r.FA_PARAMS,u=new Error(o.msg,o.err);n(u,o)}return this.emit("proxy",t),"string"==typeof t.target&&(t.target={uri:t.target}),t.changeOrigin?e.client(t.target,function(e,r){return e?n(e,r):(i.use(t.uri,function(e,t){r.request(e,t)}),void n())}):e.proxy(t.target,function(e,r){return e?n(e,r):(i.use(t.uri,r),void n())}),this},proxy:function(e,r,t,n){var i=e;return"string"==typeof e&&(i={uri:e,target:r},"boolean"==typeof t?i.changeOrigin=t:t&&"function"==typeof t&&(n=t)),this._proxy(i,n)},request:function(r,n){var i=e.utils.preRequest.apply(this,arguments);return this.handle(i.opts,i.cb||t)},handle:function(e,r,t){function n(){if(r.done)return m();if(e.baseUri=p,e.uri=h,f>=l.length)return m();for(var t,i=!1;!i&&f<l.length;)if(t=l[f++])try{i=t.match(e.uri,e.type)}catch(e){return m(e)}if(!i)return m();e.params={};for(var o in c)e.params[o]=c[o];for(var o in t.params)e.params[o]=t.params[o];t.router&&(e.baseUri=p+t.uri,e.uri=e.uri.replace(t.uri,"")),t.handle(e,r,n)}function i(e,r){for(var t=new Array(arguments.length-2),n=new Array(arguments.length-2),i=0;i<t.length;i++)t[i]=arguments[i+2],n[i]=r[t[i]];return function(i){for(var o=0;o<t.length;o++)r[t[o]]=n[o];return e&&e.apply(this,arguments),a}}if(!t){var o=e,u=r;e={};for(var s in o)e[s]=o[s];r=function(e,t){r.done||(r.done=!0,u(e,t))},t=function(){r(new Error(jm.ERR.FA_NOTFOUND.msg),jm.ERR.FA_NOTFOUND)}}var a=this,f=0,l=a.routes,c=e.params,p=e.baseUri||"",m=i(t,e,"baseUri","params");e.originalUri=e.originalUri||e.uri;var h=e.uri;return n(),a}});e.Router=i,e.router=function(e){return new i(e)}}}();var jm=jm||{};"undefined"!=typeof exports&&"undefined"!=typeof module&&(jm=require("jm-core")),function(){if(!jm.ms.utils){var e=Array.prototype.slice,r=jm.ms;r.utils={formatJSON:function(e){return JSON.stringify(e,null,2)},getUriProtocol:function(e){return e?e.substring(0,e.indexOf(":")):null},getUriPath:function(e){var r=e.indexOf("//");if(r==-1)return"";var r=e.indexOf("/",r+2);return r==-1?"":(e=e.substr(r),r=e.indexOf("#"),r==-1&&(r=e.indexOf("?")),r!=-1&&(e=e.substr(0,r)),e)},enableType:function(e,r){Array.isArray(r)||(r=[r]),r.forEach(function(r){e[r]=function(t,n){if("string"==typeof t){var i=Array.prototype.slice.call(arguments,0);return i.splice(1,0,r),e.request.apply(e,i)}return t.type=r,e.request(t,n)}})},preRequest:function(r,t){if("string"==typeof r){var n=arguments.length,i=e.call(arguments,0);t=null,"function"==typeof i[n-1]&&(t=i[n-1],n--),r={uri:r},"number"==typeof i[n-1]&&(r.timeout=i[n-1],n--);var o=1;o<n&&i[o]&&(r.type=i[o]),o++,o<n&&i[o]&&(r.data=i[o]),o++,o<n&&i[o]&&(r.params=i[o])}return{opts:r,cb:t}}}}}();var jm=jm||{};"undefined"!=typeof exports&&"undefined"!=typeof module&&(jm=require("jm-core")),function(){if(!jm.ms.client){var e=jm.ms,r=jm.ERR,t=jm.root.registries;t.ms={client:{types:{}}};var n=t.ms.client.types;e.registClientType=function(e,t){e=e||{};var i=null,o=null;if(e.type&&e.fn){var u=e.type.toLowerCase();n[u]={type:u,port:e.port,fn:e.fn}}else i=new Error("invalid params"),o=r.FA_PARAMS;return t&&t(i,o),this},e.unregistClientType=function(e,t){e=e||{};var i=null,o=null;if(e.type){var u=e.type.toLowerCase();n[u]&&delete n[u]}else i=new Error("invalid params"),o=r.FA_PARAMS;return t&&t(i,o),this},e.client=function(t,i){t=t||{};var o=null,u=null,s=null;t.uri&&(s=e.utils.getUriProtocol(t.uri)),s=t.type||s||"http",s=s.toLowerCase();var a=n[s];return a?(a.fn.call(this,t,function(r,t){e.utils.enableType(t,["get","post","put","delete"]),i(r,t)}),this):(o=new Error("invalid type"),u=r.ms.FA_INVALIDTYPE,i&&i(o,u),this)}}}();var jm=jm||{},WebSocket=WebSocket||null;!function(){"use strict";var e=999999,r=3100,t=null;"undefined"!=typeof module&&module.exports?(jm=require("jm-ms-core"),WebSocket=require("ws"),t=function(e,r){var t=new WebSocket(e);return t.on("message",function(e,t){r(e)}),t}):t=function(e,r){var t=new WebSocket(e);return t.onmessage=function(e){r(e.data)},t};var n=jm.getLogger("jm-ms-ws:client"),i=function(i,u){i=i||{};var s=null,a=null,f=!1,l=!1,c=0,p={},m={request:function(r,t){var n=o.utils.preRequest.apply(this,arguments);return r=n.opts,t=n.cb,f?(r.uri=y+(r.uri||""),t&&(c>=e&&(c=0),c++,p[c]=t,r.id=c),void a.send(JSON.stringify(r))):t(new Error(jm.ERR.FA_NETWORK.msg),jm.ERR.FA_NETWORK)},close:function(){l=!1,a.close(),a=null}};jm.enableEvent(m);var h=function(e){n.debug("received: %s",e),m.emit("message",e);var r=null;try{r=JSON.parse(e)}catch(e){return}if(r.id&&p[r.id]){var t=null,i=r.data;i.err&&(t=new Error(i.msg)),p[r.id](t,i),delete p[r.id]}},d=i.uri||"ws://127.0.0.1:"+r,v=jm.ms.utils.getUriPath(d),y=i.prefix||"";y=v+y;var g=!1,j=null,x=0,w=i.reconnectionDelay||5e3,A=0,b=i.maxReconnectAttempts||A;return m.connect=function(){if(!f){n.debug("connect to "+d);var e=m;!l&&i.reconnect&&(l=i.reconnect,g=!1,x=0);var r=function(r){n.debug("connected to "+d),f=!0,g&&e.emit("reconnect"),e.emit("open"),e.onopen&&(n.warn("Deprecated: onopen, please use on('open' function(err,doc){})."),e.onopen(r))},o=function(r){f=!1,e.emit("close"),l&&(!b||x<b)&&(g=!0,x++,j=setTimeout(function(){e.connect()},w))},u=function(e){m.emit("error")};a=t(d,h),a.onopen=r,a.onerror=u,a.onclose=o}},m.connect(),u&&u(s,m),this};n=jm.getLogger("jm-ms-ws:client");var o=jm.ms;o.registClientType({type:"ws",fn:i})}();var jm=jm||{};"undefined"!=typeof module&&module.exports&&(jm=require("jm-ms-core"),require("jm-ajax")),function(){"use strict";var e=jm.ms,r=3e3,t={};jm.enableAjax(t);var n=function(n,i){n=n||{};var o=null,u=null,s=n.uri||"http://127.0.0.1:"+r,a=n.timeout||0;return u={request:function(r,n){var i=e.utils.preRequest.apply(this,arguments);r=i.opts,n=i.cb;var o=r.type||"get";t[o]({url:s+r.uri,timeout:r.timeout||a,data:r.data,headers:r.headers||{}},n)}},jm.enableEvent(u),i&&i(o,u),u.emit("open"),this};e.registClientType({type:"http",fn:n})}();